name: Update DockerHub Organizations

on:
  schedule:
    # Run daily at 02:00 UTC (after bounty-targets-data updates)
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  issues: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch and update programs
        run: |
          echo "ðŸ”„ Fetching bug bounty programs from ALL sources..."
          python3 actions/fetch_all_programs.py
          echo "âœ… Programs fetched successfully"

      - name: Verify existing DockerHub organizations
        run: |
          echo "ðŸ” Verifying existing DockerHub organizations..."

          if [ -f scripts/all-dockerhub-orgs.sh ]; then
            chmod +x scripts/all-dockerhub-orgs.sh
            ./scripts/all-dockerhub-orgs.sh | while read -r org; do
              if [ -n "$org" ]; then
                echo "Checking: $org"

                status=$(curl -s -o /dev/null -w "%{http_code}" "https://hub.docker.com/v2/users/${org}")

                if [ "$status" -eq 200 ]; then
                  echo "âœ“ $org exists"
                elif [ "$status" -eq 404 ]; then
                  echo "âœ— $org not found"
                  echo "$org" >> missing_orgs.txt
                fi

                sleep 1
              fi
            done
          fi
          echo "âœ… Verification complete"

      - name: Generate statistics
        run: |
          echo "ðŸ“Š Generating statistics..."
          python3 actions/generate_stats.py
          echo "âœ… Statistics generated"

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add dockerhub-orgs-data/*.tsv
          git add docs/STATISTICS.md

          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            # Count new programs
            new_programs=$(git diff --staged dockerhub-orgs-data/*.tsv | grep -c "^+http" || echo "0")

            git commit -m "Daily update: Fetch latest bug bounty programs - New: $new_programs"

            git push
            echo "âœ… Changes pushed successfully"
          fi

      - name: Create issue for missing organizations
        if: hashFiles('missing_orgs.txt') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('missing_orgs.txt')) {
              const missing = fs.readFileSync('missing_orgs.txt', 'utf8');
              const orgs = missing.trim().split('\n').filter(o => o.length > 0);

              if (orgs.length > 0) {
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: `ðŸ” Missing DockerHub Organizations Detected`,
                  body: `The following DockerHub organizations appear to be missing or inaccessible:\n\n${orgs.map(o => `- ${o}`).join('\n')}\n\nThese may have been:\n- Deleted\n- Renamed\n- Made private\n- API returned an error\n\nPlease verify and update the database accordingly.`,
                  labels: ['automated', 'needs-verification']
                });
              }
            }
