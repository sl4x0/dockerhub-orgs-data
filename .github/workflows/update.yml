name: Update DockerHub Organizations

on:
  schedule:
    # Run daily at 02:00 UTC (after bounty-targets-data updates)
    - cron: "0 2 * * *"
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  issues: write

# Cancel any in-progress run of the same workflow to prevent cascading commits.
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Fetch and update programs
        run: |
          echo "ðŸ”„ Fetching bug bounty programs from ALL sources..."
          python3 actions/fetch_all_programs.py
          echo "âœ… Programs fetched successfully"

      - name: Immediately discover DockerHub orgs for new programs
        # Runs right after fetch so newly added programs don't sit as '?' for a full day.
        # Batch of 75: fast enough for a daily job (~3 min), covers most new additions.
        env:
          GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        run: |
          echo "ðŸ³ Running immediate discovery for newly added programs..."
          python3 actions/auto_discover.py 75
          echo "âœ… Immediate discovery complete"
        continue-on-error: true

      - name: Verify existing DockerHub organizations
        run: |
          echo "ðŸ” Verifying existing DockerHub organizations..."

          if [ -f scripts/all-dockerhub-orgs.sh ]; then
            chmod +x scripts/all-dockerhub-orgs.sh
            ./scripts/all-dockerhub-orgs.sh | while read -r org; do
              if [ -n "$org" ]; then
                # Validate org name is alphanumeric (no shell injection risk)
                if [[ ! "$org" =~ ^[a-zA-Z0-9_-]+$ ]]; then
                  echo "âš  Skipping invalid org name: $org"
                  continue
                fi

                echo "Checking: $org"
                status=$(curl -s -o /dev/null -w "%{http_code}" \
                  -H "User-Agent: dockerhub-orgs-data/1.0" \
                  "https://hub.docker.com/v2/users/${org}")

                # Ensure status is numeric before comparison
                if [[ ! "$status" =~ ^[0-9]+$ ]]; then
                  echo "? $org (curl error)"
                  continue
                fi

                if [ "$status" -eq 200 ]; then
                  echo "âœ“ $org exists"
                elif [ "$status" -eq 404 ]; then
                  echo "âœ— $org not found"
                  echo "$org" >> missing_orgs.txt
                else
                  echo "? $org (HTTP $status â€” transient, not recording as missing)"
                fi

                sleep 0.5
              fi
            done
          fi
          echo "âœ… Verification complete"

      - name: Generate statistics
        run: |
          echo "ðŸ“Š Generating statistics..."
          python3 actions/generate_stats.py
          echo "âœ… Statistics generated"

      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add dockerhub-orgs-data/*.tsv
          git add docs/STATISTICS.md
          git add README.md

          if git diff --staged --quiet; then
            echo "âœ… No changes to commit"
          else
            # Count new program lines added
            # NOTE: Use grep | wc -l (not grep -c) to avoid exit-code 1 on zero matches
            # which caused `|| echo "0"` to fire producing "0 0" in the commit message.
            new_programs=$(git diff --staged dockerhub-orgs-data/*.tsv | grep "^+http" | wc -l | tr -d ' ')
            # Count how many were immediately resolved to a DockerHub org
            discovered=$(git diff --staged dockerhub-orgs-data/*.tsv | grep -P "^\+.*hub\.docker\.com" | wc -l | tr -d ' ')

            git commit -m "Daily update: Fetch latest bug bounty programs - New: $new_programs, Discovered: $discovered"

            git push
            echo "âœ… Changes pushed successfully"
          fi

      - name: Create or update issue for missing organizations
        if: hashFiles('missing_orgs.txt') != ''
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (!fs.existsSync('missing_orgs.txt')) return;

            const missing = fs.readFileSync('missing_orgs.txt', 'utf8');
            const orgs = missing.trim().split('\n').filter(o => o.length > 0);
            if (orgs.length === 0) return;

            const ISSUE_TITLE = 'Missing DockerHub Organizations Detected';
            const today = new Date().toISOString().split('T')[0];
            const body = `The following DockerHub organizations returned HTTP 404 on ${today}:\n\n${orgs.map(o => `- \`${o}\``).join('\n')}\n\nThese may have been:\n- Deleted\n- Renamed\n- Made private\n\nPlease verify and update the database accordingly.`;

            // Check for an existing open issue to avoid creating duplicates daily
            const { data: openIssues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'automated,needs-verification',
              per_page: 50,
            });

            const existing = openIssues.find(i => i.title === ISSUE_TITLE);

            if (existing) {
              // Add a comment to the existing issue instead of opening a new one
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `**Updated list (${today}):**\n\n${orgs.map(o => `- \`${o}\``).join('\n')}`,
              });
              console.log(`Updated existing issue #${existing.number}`);
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: ISSUE_TITLE,
                body,
                labels: ['automated', 'needs-verification'],
              });
              console.log('Created new issue for missing organizations');
            }
